{% extends 'base.html' %}
{% block content %}
<h2 class="mb-3">Compare Movies</h2>
<form method="post" class="row g-3">
  <div class="col-md-5">
    <label class="form-label">Left movie</label>
    <input class="form-control" type="text" name="left_movie" value="{{ left_name | default('', true) }}" placeholder="e.g. Oppenheimer 2023" required>
  </div>
  <div class="col-md-5">
    <label class="form-label">Right movie</label>
    <input class="form-control" type="text" name="right_movie" value="{{ right_name | default('', true) }}" placeholder="e.g. The Dark Knight 2008" required>
  </div>
  <div class="col-md-2">
    <label class="form-label">Max reviews</label>
    <input class="form-control" type="number" name="max_reviews" value="10" min="1" max="50">
  </div>
  <div class="col-12 d-flex justify-content-end">
    <button class="btn btn-primary" type="submit">Compare</button>
  </div>
</form>

{% if (left is defined and left.summary) or (right is defined and right.summary) %}
<hr>
<div class="row g-4">
  <div class="col-md-6">
    <h5 class="mb-2">{{ left_name | default('Left movie', true) }}</h5>
    {% if left is defined and left.summary %}
      <ul>
        {% for label, count in left.summary.items() %}
          <li><strong>{{ label }}</strong>: {{ count }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">No reviews found.</p>
    {% endif %}
    {% if left is defined and left.results %}
      <div class="list-group">
        {% for row in left.results %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between"><strong>{{ row.label }}</strong> <span>score={{ '%.4f'|format(row.score) }}</span></div>
            <div class="mt-2" style="white-space: pre-wrap;">{{ row.review }}</div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
  <div class="col-md-6">
    <h5 class="mb-2">{{ right_name | default('Right movie', true) }}</h5>
    {% if right is defined and right.summary %}
      <ul>
        {% for label, count in right.summary.items() %}
          <li><strong>{{ label }}</strong>: {{ count }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">No reviews found.</p>
    {% endif %}
    {% if right is defined and right.results %}
      <div class="list-group">
        {% for row in right.results %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between"><strong>{{ row.label }}</strong> <span>score={{ '%.4f'|format(row.score) }}</span></div>
            <div class="mt-2" style="white-space: pre-wrap;">{{ row.review }}</div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<hr>
<h5 class="mb-3">Visual Comparison</h5>
<div class="row g-4">
  <div class="col-12">
    <canvas id="barCompare" height="100"></canvas>
  </div>
  <div class="col-md-6">
    <div class="card p-3">
      <h6 class="mb-2">{{ left_name | default('Left', true) }}</h6>
      <canvas id="donutLeft" height="120"></canvas>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card p-3">
      <h6 class="mb-2">{{ right_name | default('Right') }}</h6>
      <canvas id="donutRight" height="120"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function(){
  const leftSummary = JSON.parse(String.raw`{{ (left.summary if left is defined else {}) | tojson | safe }}`);
  const rightSummary = JSON.parse(String.raw`{{ (right.summary if right is defined else {}) | tojson | safe }}`);
  const leftName = JSON.parse(String.raw`{{ (left_name | default('Left')) | tojson | safe }}`);
  const rightName = JSON.parse(String.raw`{{ (right_name | default('Right')) | tojson | safe }}`);
  const labels = ['Positive','Neutral','Negative'];
  const colors = ['#16a34a','#9ca3af','#dc2626'];
  const L = [leftSummary.Positive||0, leftSummary.Neutral||0, leftSummary.Negative||0];
  const R = [rightSummary.Positive||0, rightSummary.Neutral||0, rightSummary.Negative||0];

  const ctxBar = document.getElementById('barCompare');
  if (ctxBar && (L.some(v=>v>0) || R.some(v=>v>0))) {
    new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: [leftName, rightName],
        datasets: [
          { label: 'Positive', data: [L[0], R[0]], backgroundColor: '#16a34a' },
          { label: 'Neutral',  data: [L[1], R[1]], backgroundColor: '#9ca3af' },
          { label: 'Negative', data: [L[2], R[2]], backgroundColor: '#dc2626' }
        ]
      },
      options: {
        responsive: true,
        scales: { x: { stacked: false }, y: { beginAtZero: true, ticks: { precision:0 } } },
        plugins: { legend: { labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-light') } } }
      }
    });
  }
  function donut(id, vals){
    const el = document.getElementById(id);
    if (!el) return;
    new Chart(el, {
      type: 'doughnut',
      data: { labels, datasets: [{ data: vals, backgroundColor: colors }] },
      options: { plugins: { legend: { position: 'bottom', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-light') } } } }
    });
  }
  donut('donutLeft', L);
  donut('donutRight', R);
})();
</script>
{% endif %}
{% endblock %}
